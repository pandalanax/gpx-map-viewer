<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPX Multi-Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-gpx/gpx.js"></script>
  <style>
    #map {
      height: 100vh;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    var map = L.map("map").setView([51.1657, 10.4515], 6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    fetch("/gpx-files")
      .then((response) => response.json())
      .then((files) => {
        const bounds = [];

        // Create an array of Promises for each GPX load
        const gpxPromises = files.map((file) => {
          return new Promise((resolve) => {
            const gpx = new L.GPX(`/gpx/${file}`, {
              async: true,
              markers: {
                startIcon: null,
                endIcon: null,
                wptIcons: {"": null},
                wptTypeIcons: {"": null},
                pointMatchers: [],
              },
              polyline_options: {
                color: "blue",
                opacity: 0.45,
                weight: 3,
                lineCap: "round",
              },
            })
              .on("loaded", function (e) {
                bounds.push(e.target.getBounds());
                resolve(); // resolve the promise when this file is loaded
              })
              .on("error", function (e) {
                console.error("Error loading GPX file:", file, e);
                resolve(); // Resolve anyway to not block Promise.all
              })
              .addTo(map);
          });
        });

        // After all GPX files are loaded, compute global bounds
        Promise.all(gpxPromises).then(() => {
          const fullBounds = L.latLngBounds(bounds.flat());
          map.fitBounds(fullBounds);
        });
      })
      .catch((error) =>
        console.error("Error trying to load the gpx files", error)
      );
  </body >
</html >
